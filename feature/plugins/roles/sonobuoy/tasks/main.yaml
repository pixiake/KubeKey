---
- name: Generate sonobuoy plugins
  template:
    src: plugins/
    dest: "sonobuoy/plugins/"

- name: Run sonobuoy
  command: |
    # run and waiting
    sonobuoy run --wait \
      {% if (plugins.systemd_logs.enabled) %}-p systemd-logs {% endif %}\
      {% if (plugins.e2e.enabled) %}-p e2e {% endif %}\
      {% if (plugins.e2e_ks.enabled) %}-p sonobuoy/plugins/e2e-ks.yaml {% endif %}\
      {% if (plugins.kube_bench.enabled) %}-p sonobuoy/plugins/kube-bench.yaml -p sonobuoy/plugins/kube-bench-master.yaml {% endif %}\

- name: Retrieve result
  command: |
    cd sonobuoy/ && sonobuoy retrieve

- name: Clean sonobuoy
  command: |
    sonobuoy delete 

